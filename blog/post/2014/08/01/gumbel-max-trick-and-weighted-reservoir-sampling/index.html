<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gumbel max trick and weighted reservoir sampling</title>
  <meta name="author" content="Tim Vieira">

  <link href="/blog/atom.xml" type="application/atom+xml" rel="alternate"
        title="Graduate Descent Atom Feed" />


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://timvieira.github.io/blog/favicon.png" rel="icon">
  <link href="http://timvieira.github.io/blog/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://timvieira.github.io/blog/theme/js/modernizr-2.0.js"></script>
  <script src="http://timvieira.github.io/blog/theme/js/ender.js"></script>
  <script src="http://timvieira.github.io/blog/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://timvieira.github.io/blog/">Graduate Descent</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-atom">Atom</a></li>
</ul>



<ul class="main-navigation">
    <li><a href="http://timvieira.github.io/">About</a></li>
    <li><a href="/blog/archives.html">Archive</a></li>
    <li class="active">
    <a href="http://timvieira.github.io/blog/category/misc.html">Misc</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Gumbel max trick and weighted reservoir sampling</h1>
      <p class="meta"><time datetime="2014-08-01T00:00:00" pubdate>Aug 01, 2014</time></p>
</header>

  <div class="entry-content"><p>A while back, <a href="http://people.cs.umass.edu/~wallach/">Hanna</a> and I stumbled upon
the following blog post:
<a href="http://blog.cloudera.com/blog/2013/04/hadoop-stratified-randosampling-algorithm">Algorithms Every Data Scientist Should Know: Reservoir Sampling</a>,
which got us excited about reservior sampling.</p>
<p>Around the same time, I attended an talk by
<a href="http://cs.haifa.ac.il/~tamir/">Tamir Hazan</a> about some of his work on
perturb-and-MAP
<a href="http://cs.haifa.ac.il/~tamir/papers/mean-width-icml12.pdf">(Hazan &amp; Jaakkola, 2012)</a>,
which is inspired by the
<a href="https://hips.seas.harvard.edu/blog/2013/04/06/the-gumbel-max-trick-for-discrete-distributions/">Gumbel-max-trick</a>
(see <a href="/blog/post/2014/07/31/gumbel-max-trick/">previous post</a>). The apparent
similarity between weighted reservior sampling and the Gumbel max trick lead us
to make some cute connections, which I'll describe in this post.</p>
<p><strong>The problem</strong>: We're given a stream of unnormalized probabilities, $x_1,
x_2, \cdots$. At any point in time $t$ we'd like to have a sampled index $i$
available, where the probability of $i$ is given by $\pi_t(i) = \frac{x_i}{
\sum_{j=1}^t x_j}$.</p>
<p>Assume, without loss of generality, that $x_i &gt; 0$ for all $i$. (If any element
has a zero weight we can safely ignore it since it should never be sampled.)</p>
<p><strong>Streaming Gumbel-max sampler</strong>: I came up with the following algorithm, which
is a simple "modification" of the Gumbel-max-trick for handling streaming data:</p>
<dl>
<dt>$a = -\infty; b = \text{null}  \ \ \text{# maximum value and index}$</dt>
<dt>for $i=1,2,\cdots;$ do:</dt>
<dd># Compute log-unnormalized probabilities</dd>
<dd>$w_i = \log(x_i)$</dd>
<dd># Additively perturb each weight by a Gumbel random variate</dd>
<dd>$z_i \sim \text{Gumbel}(0,1)$</dd>
<dd>$k_i = w_i + z_i$</dd>
<dd># Keep around the largest $k_i$ (i.e. the argmax)</dd>
<dd>if $k_i &gt; a$:</dd>
<dd>$\ \ \ \ a = k_i$</dd>
<dd>$\ \ \ \ b = i$</dd>
</dl>
<p>If we interrupt this algorithm at any point, we have a sample $b$.</p>
<p>After convincing myself this algorithm was correct, I sat down to try to
understand the algorithm in the blog post, which is due to Efraimidis and
Spirakis (2005) (<a href="http://dl.acm.org/citation.cfm?id=1138834">paywall</a>,
<a href="http://utopia.duth.gr/~pefraimi/research/data/2007EncOfAlg.pdf">free summary</a>). They
looked similar in many ways but used different sorting keys / perturbations.</p>
<p><strong>Efraimidis and Spirakis (2005)</strong>: Here is the ES algorithm for weighted
reservior sampling</p>
<dl>
<dt>$a = -\infty; b = \text{null}$</dt>
<dt>for $i=1,2,\cdots;$ do:</dt>
<dd># Additively perturb each weight by a Gumbel random variate,</dd>
<dd>$u_i \sim \text{Uniform}(0,1)$</dd>
<dd>$e_i = u_i^{(\frac{1}{x_i})}$</dd>
<dd># Keep around the largest $e_i$</dd>
<dd>if $k_i &gt; a$:</dd>
<dd>$\ \ \ \ a = k_i$</dd>
<dd>$\ \ \ \ b = i$</dd>
</dl>
<p>Again, if interrupt this algorithm at any point, we have our sample $b$.</p>
<p><strong>Relationship</strong>: Let's try to relate these algorithms. At a high level, both
algorithms take compute a randomized key and take an argmax. What's the
relationship between the keys?</p>
<p>First, note that a $\text{Gumbel}(0,1)$ variate can be generated via
$-\log(-\log(\text{Uniform}(0,1)))$. This is a straightforward application of
the
<a href="http://en.wikipedia.org/wiki/Inverse_transform_sampling">inverse transform sampling</a>
method for random number generation. This means that if we use the same sequence
of uniform random variates then, $z_i = -\log(-\log(u_i))$.</p>
<p>However, this does not give use equality between $k_i$ and $e_i$, but it does
turn out that $k_i = -\log(-\log(e_i))$, which is useful because this is a
monotonic transformation on the interval $(0,1)$. Since monotonic
transformations preserve ordering, the sequences $k$ and $e$ result in the same
comparison decisions, as well as, the same argmax. In summary, the algorithms
are the same!</p>
<p><strong>Extensions</strong>: After reading a little further along in the ES paper, we see
that the same algorithm can be used to perform <em>sampling without replacement</em> by
sorting and taking the elements with the highest keys. This same modification is
applicable to the Gumbel-max-trick because the keys have exactly the same
ordering as ES.In practice we don't sort the key, but instead use a bounded
priority queue.</p>
<p><strong>Closing</strong>: To the best of my knowledge, the connection between the
Gumbel-max-trick and ES is undocumented. Furthermore, the Gumbel-max-trick is
not known as a streaming algorithm, much less known to perform sampling without
replacement! If you know of a reference let me know. Perhaps, we'll finish
turning these connections into a
<a href="https://github.com/timvieira/gumbel">short tech report</a>.</p><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Tim Vieira</span>
  </span>
<time datetime="2014-08-01T00:00:00" pubdate>Aug 01, 2014</time>  <span class="categories">
    <a class="category" href="http://timvieira.github.io/blog/tag/math-sampling-gumbel.html">math sampling Gumbel</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://timvieira.github.io/blog/post/2014/08/07/complex-step-derivative/">Complex-step derivative</a>
      </li>
      <li class="post">
          <a href="http://timvieira.github.io/blog/post/2014/08/01/gumbel-max-trick-and-weighted-reservoir-sampling/">Gumbel max trick and weighted reservoir sampling</a>
      </li>
      <li class="post">
          <a href="http://timvieira.github.io/blog/post/2014/07/31/gumbel-max-trick/">Gumbel max trick</a>
      </li>
      <li class="post">
          <a href="http://timvieira.github.io/blog/post/2014/07/22/rant-against-grid-search/">Rant against grid search</a>
      </li>
      <li class="post">
          <a href="http://timvieira.github.io/blog/post/2014/07/21/expected-value-of-a-quadratic-and-the-delta-method/">Expected value of a quadratic and the Delta method</a>
      </li>
    </ul>
  </section>

<!--      
  <section>
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://timvieira.github.io/blog/category/misc.html">misc</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://timvieira.github.io/blog/tag/math-calculus.html">math calculus</a>,    <a href="http://timvieira.github.io/blog/tag/math-visualization.html">math visualization</a>,    <a href="http://timvieira.github.io/blog/tag/math-numerical.html">math numerical</a>,    <a href="http://timvieira.github.io/blog/tag/math.html">math</a>,    <a href="http://timvieira.github.io/blog/tag/math-sampling-gumbel.html">math sampling Gumbel</a>  </section>
-->



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/timvieira">@timvieira</a> on GitHub
    <script type="text/javascript">
      $.domReady(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'http://timvieira.github.io/blog/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'timvieira',
              count: 4,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="http://timvieira.github.io/blog/theme/js/github.js" type="text/javascript"> </script>
  </section>


</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2014  - Tim Vieira -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
	<script type="text/javascript">
	  var disqus_shortname = 'graduatedescent';
          var disqus_identifier = '/post/2014/08/01/gumbel-max-trick-and-weighted-reservoir-sampling/';
          var disqus_url = 'http://timvieira.github.io/blog/post/2014/08/01/gumbel-max-trick-and-weighted-reservoir-sampling/';
          var disqus_title = 'Gumbel max trick and weighted reservoir sampling';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>